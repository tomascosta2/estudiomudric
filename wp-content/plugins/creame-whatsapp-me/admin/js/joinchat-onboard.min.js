((s,o)=>{function e(t,n){return Math.round(Math.random()*(n-t)+t)}var t=JSON.parse(localStorage.joinchat_country_code||"{}"),a=!(!t.code||t.date!=(new Date).toDateString())&&t.code,c=(a||s.getJSON("https://ipinfo.io").always(function(t){a=t&&t.country?t.country:"",localStorage.joinchat_country_code=JSON.stringify({code:a,date:(new Date).toDateString()})}),{$div:null,$:function(t){return s(t||this.$div,this.$div)}}),n={init:function(){var e=this;this.step_number=0,this.step=null,this.msg=0,s.each(this,function(t,n){"function"==typeof n&&(e[t]=n.bind(e))}),this.$dialog=c.$(".joinchat__dialog"),this.$scroll=s("html,body"),this.$last_msg=null,this.saved={}},startDialog:function(){this.loadStep(),this.$dialog.on("click keydown",".joinchat__option",this.listenOption),this.$dialog.on("click",'input[type="checkbox"][readonly]',function(){return!1}),this.$dialog.on("focus","input[readonly],textarea[readonly]",function(){this.blur()})},loadStep:function(t){this.step_number=t||0,this.step=i[this.step_number]||null,this.msg=0,this.step?this.nextMessage():console.log("Joinchat: missing step "+t)},nextMessage:function(){var t=this.step.content[this.msg]||!1;t?(this.loading(),this.delay(function(){this.addMessage(t),this.msg++,this.delay(this.nextMessage)},60*t.split(/\s+/).length+e(100,200))):this.options()},addMessage:function(t,n){n=s('<div class="joinchat__message '+(n||"")+'">'+t+"</div>");t&&""==n.text().trim()&&n.addClass("joinchat__message--media"),this.$last_msg&&this.$last_msg.hasClass("joinchat__message--loading")&&this.$last_msg.remove(),this.$dialog.append(n),this.addInput(n,t),this.scrollTo(n),this.$last_msg=n},loading:function(){this.addMessage("","joinchat__message--loading")},options:function(){var e,i,o;0!=this.step.options.length&&(1==this.step.options.length&&""==this.step.options[0].text?this.doOption(this.step.options[0]):(e="",i=this.step_number,s.each((o=this).step.options,function(t,n){"contact"==n.type?o.doOption(n):e+='<div class="joinchat__option joinchat__option--'+n.type+" "+(n.class||"")+'" role="button" tabindex="0" data-option="'+i+"-"+t+'">'+n.text+"</div>"}),this.addMessage(e,"joinchat__message--options")))},reply:function(t){this.addMessage(t,"joinchat__message--reply")},scrollTo:function(t,n){this.$scroll.animate({scrollTop:t[0].offsetTop-this.$dialog[0].offsetTop},n||400)},delay:function(t,n){setTimeout(t.bind(this),n||e(400,800))},listenOption:function(t){s(t.target).hasClass("joinchat__option--disabled")||"keydown"==t.type&&13!=t.which&&32!=t.which||(t=s(t.currentTarget).data("option").split("-"),t=i[t[0]].options[t[1]],this.doOption(t))},doOption:function(t){this["doOption"+t.type.charAt(0).toUpperCase()+t.type.slice(1)](t)},doOptionGoto:function(t){this.$last_msg.remove(),""!=t.text&&this.reply(t.text),this.delay(function(){this.loadStep(t.value||this.step_number+1)},500)},doOptionLink:function(t){this.delay(function(){"!"==t.value.charAt(0)?o.open(t.value.substr(1)):o.location=t.value},250)},doOptionPhone:function(t){var n=s("#joinchat_phone").get(0);this.saved.telephone=intlTelInput.getInstance(n).getNumber(),n.readOnly=!0,this.doOptionGoto(t)},doOptionInput:function(t){c.$(t.field).prop("readOnly",!0),this.saved[t.field.substr(10)]="save"==t.action?c.$(t.field).val():"",this.doOptionGoto(t)},doOptionNewsletter:function(t){c.$(t.field).prop("readOnly",!0),this.saved.newsletter="save"==t.action?c.$(t.field).val():"",this.saveOnboard(t)},saveOnboard:function(t){var n=this;this.$last_msg.remove(),this.reply(t.text),this.loading(),s.post(ajaxurl,{action:"joinchat_onboard",nonce:joinchat_settings.nonce,data:this.saved},null,"json").always(function(){n.$last_msg.remove()}).done(function(){n.loadStep(n.step_number+(n.saved.newsletter?1:2))}).fail(function(){n.loadStep(n.step_number+3)})},addInput:function(n,t){var e,i;t.includes("{INPUT")&&(t.includes("{INPUT phone}")?(n.html(t.replace("{INPUT phone}",'<input id="joinchat_phone" value="" type="text">')),n.css("z-index",1),"function"==typeof intlTelInput&&o.intl_tel_l10n&&(e=s("#joinchat_phone"),i=intlTelInput(e[0],{hiddenInput:()=>({phone:"joinchat[telephone]"}),strictMode:!0,showSelectedDialCode:!0,initialCountry:a||"auto",customPlaceholder:t=>intl_tel_l10n.placeholder+" "+t,i18n:intl_tel_l10n}),e.on("input countrychange",function(){var t=i.isValidNumber(!0);s(this).css("color",this.value.trim()&&!t?"#ca4a1f":""),c.$(".joinchat__option--phone").toggleClass("joinchat__option--disabled",!t)}))):t.includes("{INPUT message}")?n.html(t.replace("{INPUT message}",'<textarea id="joinchat_message_send" name="joinchat[message_send]" rows="3" class="regular-text">'+joinchat_l10n.step_msg_value+"</textarea>")):t.includes("{INPUT cta}")?n.html(t.replace("{INPUT cta}",'<textarea id="joinchat_message_text" name="joinchat[message_text]" rows="4" class="regular-text">'+joinchat_l10n.step_cta_value+"</textarea>")):t.includes("{INPUT newsletter}")&&(n.html(t.replace("{INPUT newsletter}",'<input id="joinchat_email" name="joinchat[button_tip]" value="'+joinchat_settings.user_email+'" type="email" maxlength="60" class="regular-text" placeholder="john@example.com"></input>\n<div class="joinchat__optin"><input type="checkbox" id="joinchat_optin"><label for="joinchat_optin">'+joinchat_l10n.step_news_terms+"</label></div>")),n.find("#joinchat_email,#joinchat_optin").on("input change",function(){var t=n.find("#joinchat_email"),t=""!=t.val().trim()&&t.get(0).checkValidity()&&n.find("#joinchat_optin").get(0).checked;c.$(".joinchat__option--accept").toggleClass("joinchat__option--disabled",!t)})),n.find("input,textarea").get(0).focus())}},i=[{content:[joinchat_l10n.step_hi,'<img src="'+joinchat_settings.img_base+'onboard-01.png" alt="">'],options:[{type:"goto",text:joinchat_l10n.step_hi_next}]},{content:[joinchat_l10n.step_phone+":<br>{INPUT phone}"],options:[{type:"phone",class:"joinchat__option--disabled",text:joinchat_l10n.step_phone_next}]},{content:[joinchat_l10n.step_msg,'<img src="'+joinchat_settings.img_base+'onboard-02.png" alt="">',joinchat_l10n.step_msg_field+":<br>{INPUT message}"],options:[{type:"input",text:joinchat_l10n.step_msg_yes,field:"#joinchat_message_send",action:"save"},{type:"input",text:joinchat_l10n.step_msg_no,class:"joinchat__option--skip",field:"#joinchat_message_send",action:"empty"}]},{content:[joinchat_l10n.step_cta,'<img src="'+joinchat_settings.img_base+'onboard-03.png" alt="">',joinchat_l10n.step_cta_field+":<br>{INPUT cta}"],options:[{type:"input",text:joinchat_l10n.step_cta_yes,field:"#joinchat_message_text",action:"save"},{type:"input",text:joinchat_l10n.step_cta_no,class:"joinchat__option--skip",field:"#joinchat_message_text",action:"empty"}]},{content:['<img src="'+joinchat_settings.img_base+'onboard-04.png" alt="">',joinchat_l10n.step_news+"<br>{INPUT newsletter}"],options:[{type:"newsletter",class:"joinchat__option--accept joinchat__option--disabled",text:joinchat_l10n.step_news_yes,action:"save",field:"#joinchat_email,#joinchat_optin"},{type:"newsletter",text:joinchat_l10n.step_news_no,class:"joinchat__option--skip",action:"skip",field:"#joinchat_email,#joinchat_optin"}]},{content:[joinchat_l10n.step_inbox],options:[{type:"goto",text:joinchat_l10n.step_inbox_next}]},{content:[joinchat_l10n.step_success,'<img src="'+joinchat_settings.img_base+'onboard-05.png" alt="">'],options:[{type:"link",text:joinchat_l10n.step_settings,value:joinchat_settings.settings_url}]},{content:[joinchat_l10n.step_fail],options:[{type:"link",text:joinchat_l10n.step_settings,value:joinchat_settings.settings_url}]}];s(function(){c.$div=s("#joinchat_onboard"),n.init(),setTimeout(function(){n.startDialog()},700)})})(jQuery,window);